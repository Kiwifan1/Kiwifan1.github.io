<section class="planner">
  <form [formGroup]="form" class="planner__form" aria-label="Fission reactor planner">
    <fieldset class="planner__field-set">
      <legend>Reactor dimensions</legend>
      <div class="planner__grid">
        <label>
          Width
          <input type="number" formControlName="width" min="3" max="18" />
        </label>
        <label>
          Length
          <input type="number" formControlName="length" min="3" max="18" />
        </label>
        <label>
          Height
          <input type="number" formControlName="height" min="4" max="18" />
        </label>
      </div>
      <p class="planner__hint">Values must respect Mekanism's 3×4×3 – 18×18×18 bounds.</p>
    </fieldset>

    <fieldset class="planner__field-set">
      <legend>Cooling strategy</legend>
      <div class="planner__options">
        <label class="planner__option">
          <input
            type="radio"
            name="cooling"
            value="water"
            [checked]="form.value.coolingMode === 'water'"
            (change)="toggleCooling('water')"
          />
          Water cooled
        </label>
        <label class="planner__option">
          <input
            type="radio"
            name="cooling"
            value="sodium"
            [checked]="form.value.coolingMode === 'sodium'"
            (change)="toggleCooling('sodium')"
          />
          Sodium cooled
        </label>
      </div>
      <label class="planner__option" *ngIf="form.value.coolingMode === 'water'">
        <input
          type="checkbox"
          formControlName="includeBoiler"
          (change)="toggleBoiler($event.target.checked)"
        />
        Include thermoelectric boiler
      </label>
      <p class="planner__hint">Planner selects turbine and boiler sizes automatically for the requested burn rate.</p>
    </fieldset>

    <div class="planner__actions">
      <button
        type="button"
        class="planner__submit"
        [disabled]="form.invalid"
        (click)="computePlan()"
      >
        Calculate plan
      </button>
    </div>
  </form>

  <div class="planner__feedback" *ngIf="error(); else resultBlock">
    <p class="planner__error">{{ error() }}</p>
  </div>

  <ng-template #resultBlock>
    <div class="planner__results" *ngIf="result() as data">
      <section class="planner__card">
        <h2>Performance</h2>
        <ul>
          <li>Max burn rate: <strong>{{ asNumber(data.burnRate) }} mB/t</strong></li>
          <li>Safe burn rate with plan: <strong>{{ asNumber(data.safeBurnRate) }} mB/t</strong></li>
          <li>Steam demand: <strong>{{ asNumber(data.steamDemand) }} mB/t</strong></li>
          <li *ngIf="data.waterDemand">Water demand: <strong>{{ asNumber(data.waterDemand) }} mB/t</strong></li>
          <li>Estimated output: <strong>{{ asNumber(data.powerPerTick) }} FE/t</strong></li>
        </ul>
      </section>

      <section class="planner__card">
        <h2>Turbine Requirements</h2>
        <p class="planner__summary">
          {{ describeCount(data.turbines.count, 'turbine') }}
          <span class="planner__summary-detail">
            {{ data.turbines.configuration.length }} × {{ data.turbines.configuration.length }} footprint ·
            {{ data.turbines.configuration.height }} blocks tall
          </span>
        </p>
        <ul>
          <li>Per turbine steam: {{ asNumber(data.turbines.perUnitSteam) }} mB/t</li>
          <li>Per turbine return water: {{ asNumber(data.turbines.perUnitWater) }} mB/t</li>
          <li>Per turbine output: {{ asNumber(data.turbines.perUnitPower) }} FE/t</li>
        </ul>
        <ng-container *ngIf="data.turbines.construction as turbineBuild">
          <div class="planner__construction">
            <div>
              <h3>Construction (per turbine)</h3>
              <ul class="planner__construction-list">
                <li>
                  Shell casing (solid):
                  {{ asNumber(turbineBuild.perUnit.shell.solid.casing) }}
                </li>
                <li>
                  Glass-ready faces:
                  {{ asNumber(turbineBuild.perUnit.shell.withGlass.casing) }} casing ·
                  {{ asNumber(turbineBuild.perUnit.shell.withGlass.glass) }} glass
                </li>
                <li>Rotor shafts: {{ asNumber(turbineBuild.perUnit.internals.rotorShaft) }}</li>
                <li>Rotor blades: {{ asNumber(turbineBuild.perUnit.internals.rotorBlades) }}</li>
                <li>Electromagnetic coils: {{ asNumber(turbineBuild.perUnit.internals.electromagneticCoils) }}</li>
                <li>Pressure dispersers: {{ asNumber(turbineBuild.perUnit.internals.pressureDispersers) }}</li>
                <li>
                  Saturating condensers: {{ asNumber(turbineBuild.perUnit.internals.saturatingCondensers) }}
                </li>
                <li>
                  Venting (ceiling/sides):
                  {{ asNumber(turbineBuild.perUnit.internals.vents.ceiling) }} /
                  {{ asNumber(turbineBuild.perUnit.internals.vents.sides) }}
                </li>
              </ul>
              <p class="planner__construction-note">
                Rotor layers: {{ turbineBuild.perUnit.geometry.rotorLayers }} · Vent layers:
                {{ turbineBuild.perUnit.geometry.ventLayers }}
              </p>
            </div>
            <div>
              <h3>All turbines ({{ asNumber(data.turbines.count) }})</h3>
              <ul class="planner__construction-list">
                <li>
                  Shell casing (solid):
                  {{ asNumber(turbineBuild.total.shell.solid.casing) }}
                </li>
                <li>
                  Glass-ready faces:
                  {{ asNumber(turbineBuild.total.shell.withGlass.casing) }} casing ·
                  {{ asNumber(turbineBuild.total.shell.withGlass.glass) }} glass
                </li>
                <li>Rotor shafts: {{ asNumber(turbineBuild.total.internals.rotorShaft) }}</li>
                <li>Rotor blades: {{ asNumber(turbineBuild.total.internals.rotorBlades) }}</li>
                <li>
                  Electromagnetic coils:
                  {{ asNumber(turbineBuild.total.internals.electromagneticCoils) }}
                </li>
                <li>Pressure dispersers: {{ asNumber(turbineBuild.total.internals.pressureDispersers) }}</li>
                <li>
                  Saturating condensers: {{ asNumber(turbineBuild.total.internals.saturatingCondensers) }}
                </li>
                <li>
                  Venting (ceiling/sides):
                  {{ asNumber(turbineBuild.total.internals.vents.ceiling) }} /
                  {{ asNumber(turbineBuild.total.internals.vents.sides) }}
                </li>
              </ul>
            </div>
          </div>
        </ng-container>
      </section>

      <section class="planner__card" *ngIf="data.boiler as boiler">
        <h2>Boiler Requirements</h2>
        <p class="planner__summary">
          {{ describeCount(boiler.count, 'thermoelectric boiler') }}
          <span class="planner__summary-detail">
            {{ boiler.configuration.width }} × {{ boiler.configuration.length }} footprint ·
            {{ boiler.configuration.height }} blocks tall
          </span>
        </p>
        <ul>
          <li>Per boiler steam: {{ asNumber(boiler.perUnitSteam) }} mB/t</li>
          <li>Per boiler heat: {{ asNumber(boiler.perUnitHeat) }} J/t</li>
          <li>Superheaters per boiler: {{ asNumber(boiler.perUnitSuperheaters) }}</li>
          <li *ngIf="boiler.requiredHeat !== undefined">
            Required heat input: {{ asNumber(boiler.requiredHeat) }} J/t
          </li>
        </ul>
        <ng-container *ngIf="boiler.construction as boilerBuild">
          <div class="planner__construction">
            <div>
              <h3>Construction (per boiler)</h3>
              <ul class="planner__construction-list">
                <li>
                  Shell casing (solid):
                  {{ asNumber(boilerBuild.perUnit.shell.solid.casing) }}
                </li>
                <li>
                  Glass-ready faces:
                  {{ asNumber(boilerBuild.perUnit.shell.withGlass.casing) }} casing ·
                  {{ asNumber(boilerBuild.perUnit.shell.withGlass.glass) }} glass
                </li>
                <li>Superheating elements: {{ asNumber(boilerBuild.perUnit.internals.superheaters) }}</li>
                <li>Pressure dispersers: {{ asNumber(boilerBuild.perUnit.internals.pressureDispersers) }}</li>
                <li>Boiler valves (recommended): {{ asNumber(boilerBuild.perUnit.internals.valves) }}</li>
                <li>
                  Resistive heating elements:
                  {{ asNumber(boilerBuild.perUnit.internals.resistiveHeatingElements) }}
                </li>
              </ul>
              <p class="planner__construction-note">
                Water layers: {{ boilerBuild.perUnit.geometry.waterLayers }} · Steam layers:
                {{ boilerBuild.perUnit.geometry.steamLayers }}
              </p>
            </div>
            <div>
              <h3>All boilers ({{ asNumber(boiler.count) }})</h3>
              <ul class="planner__construction-list">
                <li>
                  Shell casing (solid):
                  {{ asNumber(boilerBuild.total.shell.solid.casing) }}
                </li>
                <li>
                  Glass-ready faces:
                  {{ asNumber(boilerBuild.total.shell.withGlass.casing) }} casing ·
                  {{ asNumber(boilerBuild.total.shell.withGlass.glass) }} glass
                </li>
                <li>Superheating elements: {{ asNumber(boilerBuild.total.internals.superheaters) }}</li>
                <li>
                  Pressure dispersers: {{ asNumber(boilerBuild.total.internals.pressureDispersers) }}
                </li>
                <li>
                  Boiler valves (recommended): {{ asNumber(boilerBuild.total.internals.valves) }}
                </li>
                <li>
                  Resistive heating elements:
                  {{ asNumber(boilerBuild.total.internals.resistiveHeatingElements) }}
                </li>
              </ul>
            </div>
          </div>
        </ng-container>
      </section>

      <section class="planner__card">
        <h2>Reactor Construction</h2>
        <ul>
          <li>Shell casing: {{ asNumber(data.construction.Shell.solid.casing) }}</li>
          <li>Control rods: {{ asNumber(data.construction.ControlRods) }}</li>
          <li>Max rod height: {{ asNumber(data.construction.MaxRodHeight) }}</li>
          <li>Fuel assemblies: {{ asNumber(data.construction.FissileFuelAssemblies) }}</li>
          <li>Coolant capacity: {{ asNumber(data.construction.CoolantCapacity) }} mB</li>
          <li>Hot coolant capacity: {{ asNumber(data.construction.HotCoolantCapacity) }} mB</li>
        </ul>
      </section>
      <app-structure-visualizer
        class="planner__visualizer"
        [turbine]="data.turbines"
        [boiler]="data.boiler"
      ></app-structure-visualizer>
    </div>
  </ng-template>
</section>
