<div class="planner">
  <section class="section-card section-card--flush planner__crumb">
    <a routerLink="/tools/minecraft" class="back-link">Back to Minecraft tools</a>
  </section>

  <section class="section-card planner__intro">
    <span class="planner__eyebrow">Mekanism</span>
    <h1>Fission System Planner</h1>
    <p>
      Enter your Mekanism configuration and desired reactor layout to see how many industrial
      turbines and thermoelectric boilers you need to safely process the output.
    </p>
  </section>

  <form class="section-card planner__card" [formGroup]="configForm" novalidate>
    <h2>Config defaults</h2>
    <p class="planner__muted">
      These values mirror the relevant options in <code>config/Mekanism/fission.toml</code> and
      <code>config/Mekanism/machines.toml</code>. Adjust them if your pack overrides the Mekanism
      defaults.
    </p>
    <div class="planner__grid planner__grid--config">
      <label class="planner__field">
        <span>Steam per mB fuel (mB)</span>
        <input type="number" formControlName="steamPerFuel" min="1" step="1000" />
      </label>
      <label class="planner__field">
        <span>Water heating rate (mB/t)</span>
        <input type="number" formControlName="waterCoolantRate" min="1" step="1000" />
      </label>
      <label class="planner__field">
        <span>Sodium heating rate (mB/t)</span>
        <input type="number" formControlName="sodiumCoolantRate" min="1" step="1000" />
      </label>
      <label class="planner__field">
        <span>Boil capacity per superheater (mB/t)</span>
        <input type="number" formControlName="boilCapacityPerSuperheater" min="1" step="1000" />
      </label>
      <label class="planner__field">
        <span>Steam cavity capacity per block (mB)</span>
        <input type="number" formControlName="steamCapacityPerBlock" min="1" step="1000" />
      </label>
      <label class="planner__field">
        <span>Hot coolant capacity per block (mB)</span>
        <input type="number" formControlName="hotCoolantCapacityPerBlock" min="1" step="1000" />
      </label>
      <label class="planner__field">
        <span>Water cavity capacity per block (mB)</span>
        <input type="number" formControlName="waterCapacityPerBlock" min="1" step="100" />
      </label>
      <label class="planner__field">
        <span>Default reactor ports</span>
        <input type="number" formControlName="defaultReactorPorts" min="0" step="1" />
      </label>
      <label class="planner__field">
        <span>Default boiler valves</span>
        <input type="number" formControlName="defaultBoilerValves" min="0" step="1" />
      </label>
      <label class="planner__field">
        <span>Mechanical pipe throughput (mB/t)</span>
        <input type="number" formControlName="mechanicalPipeRate" min="1" step="1000" />
      </label>
      <label class="planner__field">
        <span>Pressurized pipe throughput (mB/t)</span>
        <input type="number" formControlName="pressurizedPipeRate" min="1" step="1000" />
      </label>
    </div>
    <div class="planner__actions">
      <button type="button" (click)="resetConfig()" class="planner__ghost">Reset to Mekanism defaults</button>
    </div>
    <p class="planner__hint" *ngIf="configForm.invalid && configForm.touched">
      All config values must be positive before running the planner.
    </p>
  </form>

  <form class="section-card planner__card" [formGroup]="reactorForm" novalidate>
    <h2>Reactor layout</h2>
    <div class="planner__grid planner__grid--reactor">
      <label class="planner__field">
        <span>Width (external)</span>
        <input type="number" formControlName="width" min="3" max="18" step="1" />
      </label>
      <label class="planner__field">
        <span>Height (external)</span>
        <input type="number" formControlName="height" min="4" max="18" step="1" />
      </label>
      <label class="planner__field">
        <span>Length (external)</span>
        <input type="number" formControlName="length" min="3" max="18" step="1" />
      </label>
      <label class="planner__field planner__field--wide">
        <span>Target burn rate (mB/t)</span>
        <input type="number" formControlName="burnRate" min="1" step="1" />
      </label>
    </div>
    <p class="planner__hint">
      Maximum burn for this footprint: <strong>{{ maxBurnRate() | number }}</strong> mB/t
    </p>
  </form>

  <form
    class="section-card planner__card planner__card--actions"
    [formGroup]="operationForm"
    (ngSubmit)="runPlanner()"
    novalidate
  >
    <h2>Operation</h2>
    <div class="planner__row">
      <fieldset class="planner__fieldset">
        <legend>Cooling loop</legend>
        <label>
          <input type="radio" formControlName="cooling" value="water" />
          Water
        </label>
        <label>
          <input type="radio" formControlName="cooling" value="sodium" />
          Sodium
        </label>
      </fieldset>
      <label class="planner__toggle">
        <input type="checkbox" formControlName="useBoiler" />
        Include boiler on the water loop
      </label>
    </div>
    <div class="planner__actions planner__actions--submit">
      <button type="submit" class="planner__primary">Generate plan</button>
    </div>
  </form>

  <p class="planner__error" *ngIf="error() as message">{{ message }}</p>

  <section class="section-card planner__results" *ngIf="result() as plan">
    <h2>Recommended layout</h2>
    <div class="results-grid">
      <article class="results-card">
        <h3>Reactor</h3>
        <dl>
          <div>
            <dt>Dimensions</dt>
            <dd>
              {{ plan.reactor.cost.dimensions.width }} ×
              {{ plan.reactor.cost.dimensions.height }} ×
              {{ plan.reactor.cost.dimensions.length }}
            </dd>
          </div>
          <div>
            <dt>Burn rate</dt>
            <dd>{{ plan.reactor.burnRate | number }} mB/t</dd>
          </div>
          <div>
            <dt>Steam output</dt>
            <dd>{{ plan.reactor.steamPerTick | number }} mB/t</dd>
          </div>
          <div>
            <dt>{{ plan.cooling === 'sodium' ? 'Superheated sodium' : 'Heated water' }}</dt>
            <dd>{{ plan.reactor.coolantPerTick | number }} mB/t</dd>
          </div>
          <div>
            <dt>Control rods</dt>
            <dd>{{ plan.reactor.cost.controlRodAssemblies | number }}</dd>
          </div>
          <div>
            <dt>Fuel assemblies</dt>
            <dd>{{ plan.reactor.cost.fissileFuelAssemblies | number }}</dd>
          </div>
          <div>
            <dt>Ports</dt>
            <dd>{{ plan.reactor.cost.ports }}</dd>
          </div>
          <div>
            <dt>Casing (with glass)</dt>
            <dd>
              {{ plan.reactor.cost.shell.withGlass.casing | number }} casing,
              {{ plan.reactor.cost.shell.withGlass.glass | number }} glass
            </dd>
          </div>
        </dl>
      </article>

      <article class="results-card">
        <h3>Turbines</h3>
        <dl>
          <div>
            <dt>Count</dt>
            <dd>{{ plan.turbines.count }}</dd>
          </div>
          <div>
            <dt>Dimensions</dt>
            <dd>
              {{ plan.turbines.design.dimensions.width }} ×
              {{ plan.turbines.design.dimensions.height }} ×
              {{ plan.turbines.design.dimensions.length }}
            </dd>
          </div>
          <div>
            <dt>Steam per turbine</dt>
            <dd>{{ plan.turbines.steamPerUnit | number }} mB/t</dd>
          </div>
          <div>
            <dt>Utilisation</dt>
            <dd>{{ (plan.turbines.utilisation * 100) | number:'1.0-2' }}%</dd>
          </div>
          <div>
            <dt>Power per turbine</dt>
            <dd>{{ plan.turbines.powerPerUnit | number }} FE/t</dd>
          </div>
          <div>
            <dt>Total power</dt>
            <dd>{{ plan.turbines.totalPower | number }} FE/t</dd>
          </div>
          <div>
            <dt>Condensers</dt>
            <dd>
              {{ plan.turbines.condensersTotal | number }} total
              ({{ plan.turbines.condensersPerUnit | number }} each)
            </dd>
          </div>
          <div>
            <dt>Rotors</dt>
            <dd>
              {{ (plan.turbines.design.rotors * plan.turbines.count) | number }} total
              ({{ plan.turbines.design.rotors | number }} each)
            </dd>
          </div>
          <div>
            <dt>Blades</dt>
            <dd>
              {{ (plan.turbines.design.blades * plan.turbines.count) | number }} total
              ({{ plan.turbines.design.blades | number }} each)
            </dd>
          </div>
          <div>
            <dt>Electromagnetic coils</dt>
            <dd>
              {{ (plan.turbines.design.coils * plan.turbines.count) | number }} total
              ({{ plan.turbines.design.coils | number }} each)
            </dd>
          </div>
          <div>
            <dt>Pressure dispersers</dt>
            <dd>
              {{ (plan.turbines.design.pressureDispersers * plan.turbines.count) | number }} total
            </dd>
          </div>
          <div>
            <dt>Rotational complexes</dt>
            <dd>{{ plan.turbines.count }}</dd>
          </div>
          <div>
            <dt>Vents</dt>
            <dd>
              {{ (plan.turbines.design.performance.ventBlocks * plan.turbines.count) | number }}
              total
            </dd>
          </div>
          <div>
            <dt>Mechanical pipes</dt>
            <dd>
              {{ plan.turbines.mechanicalPipesTotal | number }} total
              ({{ plan.turbines.mechanicalPipesPerUnit | number }} each)
            </dd>
          </div>
          <div>
            <dt>Pressurized pipes</dt>
            <dd>
              {{ plan.turbines.pressurisedPipesTotal | number }} total
              ({{ plan.turbines.pressurisedPipesPerUnit | number }} each)
            </dd>
          </div>
          <div>
            <dt>Shell (totals)</dt>
            <dd>
              {{ (plan.turbines.design.shell.withGlass.casing * plan.turbines.count) | number }} casing,
              {{ (plan.turbines.design.shell.withGlass.glass * plan.turbines.count) | number }} glass
            </dd>
          </div>
        </dl>
      </article>

      <article class="results-card" *ngIf="plan.boiler as boiler">
        <h3>Thermoelectric boilers</h3>
        <dl>
          <div>
            <dt>Count</dt>
            <dd>{{ boiler.count }}</dd>
          </div>
          <div>
            <dt>Dimensions</dt>
            <dd>
              {{ boiler.plan.dimensions.width }} ×
              {{ boiler.plan.dimensions.height }} ×
              {{ boiler.plan.dimensions.length }}
            </dd>
          </div>
          <div>
            <dt>Water/steam cavities</dt>
            <dd>{{ boiler.plan.waterCavityHeight }} / {{ boiler.plan.steamCavityHeight }} layers</dd>
          </div>
          <div>
            <dt>Superheaters</dt>
            <dd>{{ (boiler.plan.superheatingElements * boiler.count) | number }} total</dd>
          </div>
          <div>
            <dt>Steam per boiler</dt>
            <dd>{{ boiler.steamPerUnit | number }} mB/t</dd>
          </div>
          <div>
            <dt>Hot coolant per boiler</dt>
            <dd>{{ boiler.hotCoolantPerUnit | number }} mB/t</dd>
          </div>
          <div>
            <dt>Pressure dispersers</dt>
            <dd>{{ (boiler.plan.pressureDispersers * boiler.count) | number }} total</dd>
          </div>
          <div>
            <dt>Valves</dt>
            <dd>{{ (boiler.plan.valves * boiler.count) | number }} total</dd>
          </div>
          <div>
            <dt>Shell (totals)</dt>
            <dd>
              {{ (boiler.plan.shell.withGlass.casing * boiler.count) | number }} casing,
              {{ (boiler.plan.shell.withGlass.glass * boiler.count) | number }} glass
            </dd>
          </div>
        </dl>
      </article>

      <article class="results-card">
        <h3>Inputs used</h3>
        <dl>
          <div>
            <dt>Steam per fuel</dt>
            <dd>{{ plan.overrides.steamPerFuel | number }} mB</dd>
          </div>
          <div>
            <dt>Water heating</dt>
            <dd>{{ plan.overrides.waterCoolantRate | number }} mB/t</dd>
          </div>
          <div>
            <dt>Sodium heating</dt>
            <dd>{{ plan.overrides.sodiumCoolantRate | number }} mB/t</dd>
          </div>
          <div>
            <dt>Boil per superheater</dt>
            <dd>{{ plan.overrides.boilCapacityPerSuperheater | number }} mB/t</dd>
          </div>
          <div>
            <dt>Steam storage</dt>
            <dd>{{ plan.overrides.steamCapacityPerBlock | number }} mB per block</dd>
          </div>
          <div>
            <dt>Hot coolant storage</dt>
            <dd>{{ plan.overrides.hotCoolantCapacityPerBlock | number }} mB per block</dd>
          </div>
          <div>
            <dt>Water storage</dt>
            <dd>{{ plan.overrides.waterCapacityPerBlock | number }} mB per block</dd>
          </div>
          <div>
            <dt>Reactor ports</dt>
            <dd>{{ plan.overrides.defaultReactorPorts }}</dd>
          </div>
          <div>
            <dt>Boiler valves</dt>
            <dd>{{ plan.overrides.defaultBoilerValves }}</dd>
          </div>
          <div>
            <dt>Mechanical pipe rate</dt>
            <dd>{{ plan.overrides.mechanicalPipeRate | number }} mB/t</dd>
          </div>
          <div>
            <dt>Pressurized pipe rate</dt>
            <dd>{{ plan.overrides.pressurizedPipeRate | number }} mB/t</dd>
          </div>
        </dl>
      </article>
    </div>
  </section>
</div>
